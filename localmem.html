<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>localStorage 30MB random (safe)</title>
<style>
  body { font-family: monospace; padding: 20px; }
  pre { background:#eee; padding:10px; border-radius:6px; height:300px; overflow:auto; }
</style>
</head>
<body>
<h1>localStorage にランダムを30MB保存</h1>
<button id="start">開始</button>
<button id="clear">削除</button>
<p id="status">未開始</p>
<pre id="log"></pre>
<script>
(async function(){
  const TARGET_MB = 30;
  const CHUNK_BYTES = 1 * 1024 * 1024; // 1MiB
  const PREFIX = "rs_part_";
  const MAX_RANDOM = 65536; // crypto.getRandomValues の上限（64KB）
  const status = document.getElementById("status");
  const log = document.getElementById("log");
  const startBtn = document.getElementById("start");
  const clearBtn = document.getElementById("clear");

  function append(...a){ log.textContent += a.join(" ") + "\n"; log.scrollTop = log.scrollHeight; }

  // 安全な乱数生成関数（64KBごとに分割）
  function safeRandom(size){
    const buf = new Uint8Array(size);
    for(let i=0; i<size; i+=MAX_RANDOM){
      const slice = buf.subarray(i, i+Math.min(MAX_RANDOM, size-i));
      crypto.getRandomValues(slice);
    }
    return buf;
  }

  function uint8ToBase64(u8){
    return new Promise((resolve,reject)=>{
      const blob = new Blob([u8]);
      const fr = new FileReader();
      fr.onload = ()=>resolve(fr.result.split(",")[1]);
      fr.onerror = reject;
      fr.readAsDataURL(blob);
    });
  }

  async function storeRandomToLocalStorage(){
    let total = 0;
    const target = TARGET_MB * 1024 * 1024;
    for(let i=0; i<Math.ceil(target/CHUNK_BYTES); i++){
      const remain = target-total;
      const thisSize = Math.min(CHUNK_BYTES, remain);
      append(`生成中 ${i+1} (${thisSize} bytes)`);
      const u8 = safeRandom(thisSize);
      const b64 = await uint8ToBase64(u8);
      try {
        localStorage.setItem(PREFIX+i, b64);
        total += thisSize;
        status.textContent = `保存中: ${(total/1024/1024).toFixed(2)}MB`;
      } catch(e){
        append("❌ 保存失敗:", e.name);
        break;
      }
      await new Promise(r=>setTimeout(r,20));
    }
    append(`完了: 保存済み ${(total/1024/1024).toFixed(2)}MB`);
    status.textContent = "完了";
  }

  function clearAll(){
    const keys = [];
    for(let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if(k.startsWith(PREFIX)) keys.push(k);
    }
    keys.forEach(k=>localStorage.removeItem(k));
    append("削除:", keys.length, "個");
    status.textContent = "削除完了";
  }

  startBtn.onclick = storeRandomToLocalStorage;
  clearBtn.onclick = clearAll;
})();
</script>
</body>
</html>
