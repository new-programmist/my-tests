<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Safari ストレージ埋めテスト</title>
<style>
body { font-family: monospace; padding: 20px; }
#log { white-space: pre-wrap; background:#eee; padding:10px; height:300px; overflow:auto; }
</style>
</head>
<body>
<h1>Safari ストレージ埋めテスト</h1>
<button id="start">IndexedDB + CacheStorage を埋める</button>
<button id="clear">削除</button>
<pre id="log"></pre>

<script>
async function fillIndexedDB(sizeMB=400){
  const CHUNK = 2*1024*1024;
  const db = await new Promise((res, rej)=>{
    const r = indexedDB.open('fillDB',1);
    r.onupgradeneeded=e=>e.target.result.createObjectStore('chunks',{keyPath:'id'});
    r.onsuccess=e=>res(e.target.result);
    r.onerror=rej;
  });
  const tx=db.transaction('chunks','readwrite');
  const store=tx.objectStore('chunks');
  let total=0,i=0;
  while(total<sizeMB*1024*1024){
    const arr=new Uint8Array(CHUNK);
    crypto.getRandomValues(arr.subarray(0,65536)); // only fill head
    await new Promise((ok, ng)=>{
      const r=store.put({id:i, blob:arr});
      r.onsuccess=ok; r.onerror=ng;
    });
    total+=CHUNK; i++;
    log(`IndexedDB ${Math.round(total/1024/1024)}MB`);
    await new Promise(r=>setTimeout(r,10));
  }
}

async function fillCacheStorage(sizeMB=400){
  const cache = await caches.open('fillCache');
  let total = 0;
  while(total < sizeMB*1024*1024){
    const blob = new Blob([new Uint8Array(1024*1024).fill(Math.random()*255)], {type:'application/octet-stream'});
    await cache.put(`/data${total}.bin`, new Response(blob));
    total += 1024*1024;
    log(`CacheStorage ${Math.round(total/1024/1024)}MB`);
    await new Promise(r=>setTimeout(r,10));
  }
}

function log(msg){ const el=document.getElementById('log'); el.textContent+=msg+'\n'; el.scrollTop=el.scrollHeight; }

document.getElementById('start').onclick=async()=>{
  try{
    log('=== IndexedDB ===');
    await fillIndexedDB(400);
  }catch(e){log('IndexedDB停止:'+e.name);}
  try{
    log('=== CacheStorage ===');
    await fillCacheStorage(400);
  }catch(e){log('Cache停止:'+e.name);}
  log('完了');
};

document.getElementById('clear').onclick=async()=>{
  indexedDB.deleteDatabase('fillDB');
  caches.delete('fillCache');
  log('削除完了');
};
</script>
</body>
</html>
