<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>チャット</title>
<style>
body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;margin:18px}
label,input,button,textarea{font-size:14px}
#log{white-space:pre-wrap;background:#111;color:#eee;padding:12px;border-radius:8px;min-height:200px;overflow:auto}
.row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.grow{flex:1}
textarea{width:100%;height:60px}
a{color:#0af}
</style>
</head>
<body>
<h2>チャット</h2>
<div class="row">
  <label for="username">ユーザー名</label>
  <input id="username" class="grow" value="guest" />
  <button id="connectBtn">接続</button>
  <button id="disconnectBtn" disabled>切断</button>
</div>

<div class="row">
  <label for="project" hidden>プロジェクトID</label>
  <input id="project" value="00912" hidden/>
  <button id="sendHandshake" hidden>ハンドシェイク送信</button>
</div>

<div class="row">
  <label for="message">メッセージ</label>
  <textarea id="message"></textarea>
  <button id="encodeSend">エンコードして送信</button>
</div>

<div class="row">
  <label><input type="checkbox" id="soundToggle" checked /> メッセージで音を鳴らす</label>
</div>

<h3>ログ</h3>
<div id="log"></div>

<script>
const url = 'wss://clouddata.turbowarp.org/';
let ws = null;
const logEl = document.getElementById('log');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const sendHandshakeBtn = document.getElementById('sendHandshake');
const encodeSendBtn = document.getElementById('encodeSend');
const soundToggle = document.getElementById('soundToggle');

const popBase64 = "UklGRigCAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQQCAADVAAMDvQdyDe8VUx08I5sk4iCrFnMGVfFf2mDEjbNpqZKo5bFHxUHh8wLtJtFHSmF9byNwCmHOROodKvMPyWqn/ZElje6YObXo3eIMnTpEYHB2tXmiaNhFZxdK5Gy1epLegWuGcZ+OyCH84jB9Xd955H83calNthyp50+4jJYDiWmRT6712VwMADxQX+9vF2lWTgokcfJZxWejtpN4mfiyaNqjCY42a1cpZqJfvEb1H8jyA8r1rc6iH6syxPHqwBSrOShR8VY0SU4rAwQs27667KgOqdG8jN28BjwugEsUWSdSXTmsExzqccWtrSmnurMb0LD2pR56P8hRylFrP30f5/nT1oG+H7ZVvqzVvPUqGIIz9UGEQCwvDBNX8p/Vs8P1v3TLnON6AnogiTaGP9I4OiTDBpLnG86GvwjAFc9R6WsIfiUgOghBtTiWI1MGL+hWzyrC6sJa0QXqSQeUItc10DzsNUojWglH7hvYd8sNy2bWb+qxApIZMyp4MKorPB30CGTzv+G41/bWrN8Q780BKRNcH6gjSB+rE68DUvNw5rrf2+Az6cz2JAbbE/IcSh+EGskPfAHk8jXnDeGG4XroZ/ShAiwQXxoQH4wdXhY9C3T+5/LK6pbnhOng7/n41AIIC0oQkhHZDjcJGQJ5+532lvTd9df5H/+OBJcIFwqKCFUEYf4=";
let userInteracted = false;
function playPopSound() {
  if (!soundToggle.checked) return;
  if (!userInteracted) return;
  const popSound = new Audio("data:audio/wav;base64," + popBase64);
  popSound.play().catch(()=>{});
}

function addLog(text){
  const htmlText = text.replace(/\(__LINK__\s+TITLE=".*?"\s+URL="(.*?)"\)/g, (match,url)=>{
    return `<a href="${url}" target="_blank">画像</a>`;
  });
  logEl.innerHTML += htmlText + '<br>';
  logEl.scrollTop = logEl.scrollHeight;
}

function log(...args){
  const t = new Date().toISOString();
  addLog(`[${t}] ` + args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' '));
}

function makeHandshakePayload(){
  return {
    method: 'handshake',
    user: document.getElementById('username').value,
    project_id: document.getElementById('project').value
  };
}

function encodeMessage(msg) {
  const user = document.getElementById('username').value; 
  const fullMsg = user + ": " + msg;
  return Array.from(fullMsg)
      .map(char => char.codePointAt(0).toString().padStart(6,'0'))
      .join('');
}

function decodeValue(str) {
  try {
      if (str.length % 6 !== 0) throw new Error("文字列の長さが不正です");
      let result = '';
      for (let i=0;i<str.length;i+=6){
          const code = parseInt(str.slice(i,i+6),10);
          if(isNaN(code)) throw new Error("不正な数値が含まれています");
          result += String.fromCodePoint(code);
      }
      return result;
  } catch(e){
      return `エラー: ${e.message}`;
  }
}

function openWs(){
  if(ws && ws.readyState === WebSocket.OPEN) return;
  ws = new WebSocket(url);

  ws.addEventListener('open', ()=>{
    userInteracted = true; 
    log('接続完了', '');
    connectBtn.disabled = true;
    disconnectBtn.disabled = false;
    try{
      const payload = makeHandshakePayload();
      ws.send(JSON.stringify(payload));
    }catch(e){
      log('ハンドシェイク送信失敗:', e.message);
    }
  });

  ws.addEventListener('message', ev=>{
    let data = ev.data;
    try{ data = JSON.parse(ev.data); }
    catch(e){}
    if(data && data.method==='set' && data.name==='☁ 0'){
      const decoded = decodeValue(data.value);
      log(decoded);
      playPopSound();
    } else {
      log('受信: ' + JSON.stringify(data));
    }
  });

  ws.addEventListener('close', ev=>{
    log('WebSocket切断', ev.code, ev.reason);
    connectBtn.disabled = false;
    disconnectBtn.disabled = true;
  });

  ws.addEventListener('error', ev=>{
    log('WebSocketエラー', ev);
  });
}

function closeWs(){
  if(!ws) return;
  ws.close(1000,'client disconnect');
  ws = null;
}

connectBtn.addEventListener('click', openWs);
disconnectBtn.addEventListener('click', closeWs);

sendHandshakeBtn.addEventListener('click', ()=>{
  if(!ws || ws.readyState!==WebSocket.OPEN){ log('WebSocket未接続'); return; }
  const payload = makeHandshakePayload();
  ws.send(JSON.stringify(payload));
  log('ハンドシェイク送信 (手動):', payload);
});

encodeSendBtn.addEventListener('click', ()=>{
  if(!ws || ws.readyState!==WebSocket.OPEN){ log('WebSocket未接続'); return; }
  const msg = document.getElementById('message').value;
  if(!msg.trim()) return;
  const encoded = encodeMessage(msg);
  const payload = {
    method:'set',
    user:document.getElementById('username').value,
    project_id:document.getElementById('project').value,
    name:'☁ 0',
    value: encoded
  };
  ws.send(JSON.stringify(payload));
  log(`${document.getElementById('username').value}(あなた): ${msg}`);
  document.getElementById('message').value = '';
});
</script>
</body>
</html>
